---
layout: post
title: "Headless Chrome with 
BrowserMob Proxy"
date: 2017-09-24
---

Chrome has now added a new option to run tests in headless mode with chromedriver. This requires to add an argument --headless to ChromeOptions so that chromedriver opens chrome with headless option. 

<pre class="hightlight"><code>
DesiredCapabilities capabilities = new DesiredCapabilities();
capabilities.setBrowserName(BrowserType.CHROME);
ChromeOptions options = new ChromeOptions();
options.addArguments("--headless");
capabilities.setCapability(ChromeOptions.CAPABILITY, options);
ChromeDriverService service = new ChromeDriverService.Builder().usingAnyFreePort().usingDriverExecutable(CHROMEDRIVER_LOCATION).build();
WebDriver chromedriver = new ChromeDriver(service, capabilities);
</code></pre> 

Now, using the above code webdriver will run the tests in headless mode. That seems quite easy, but if you happen to use BrowserMobProxy to capture network requests, chrome wont load page in headless mode. You wont notice this until you start looking for HarEntry in HarLog only to find that no HarEntry is being captured. When chromedriver opens chrome in GUI mode with BrowserMob proxy, you will notice a warning 'Your connection to this site is not secure' on the address bar. This is because BrowserMob uses Mitm(Man in the middle) to capture HTTPS requests, which terminates SSL and re-encrypts using its own private key. The certificate generated by BrowserMob is deemed not secure because its not present in any trust source. This all still works in GUI mode because chromedriver adds --ignore-certificate-errors argument to chrome and chrome only shows a warning. But, as of now chrome does not respect --ignore-certificate-errors options once --headless option is detected. So ssl warning in headless mode actually becomes an error and chrome wont load the page. 
To remediate this you can install <a href="https://github.com/lightbody/browsermob-proxy/blob/master/browsermob-core/src/main/resources/sslSupport/ca-certificate-rsa.cer">BrowserMob root CA</a> to trust store on your machine. You could also generate your own CA private key and certificate and install on your trust store using the instructions in <a href="https://github.com/lightbody/browsermob-proxy/blob/master/mitm/README.md">BrowserMob Mitm README</a>. 

